name: DevSecOps Compliance CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Linter and Type Checker # PCI-DSS: Secure coding practices; SOX: SDLC Governance
        run: |
          echo "Running code quality checks..."
          # Placeholder: Add actual lint/type check commands here, e.g., npm run lint, python -m flake8

  unit-test:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - uses: actions/checkout@v4
      - name: Run Unit Tests # SOX: Validate software functionality; NIST CSF: PR.DS-01
        run: |
          echo "Running unit tests..."
          # Placeholder: Add actual unit test commands here, e.g., npm test, pytest

  sast:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - uses: actions/checkout@v4
      - name: Run Semgrep SAST # PCI-DSS: Detect insecure coding patterns (SQLi, XSS); NIST CSF: PR.DS-01
        uses: returntocorp/semgrep-action@v1
        with:
          config: |
            p/security-audit
            p/r/sql-injection
            p/r/xss
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  secret-detection:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - uses: actions/checkout@v4
      - name: Run Gitleaks Scan # PCI-DSS: Prevent credential leakage; NIST CSF: PR.PT-01
        uses: zricethezav/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sca:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy SCA # PCI-DSS: Identify known vulnerabilities in dependencies; NIST CSF: PR.IP-01
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          severity: 'HIGH,CRITICAL'
          format: 'sarif'
          output: 'trivy-results.sarif'
      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  sbom:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - uses: actions/checkout@v4
      - name: Generate SBOM with Syft # PCI-DSS: Maintain inventory of software components; NIST CSF: ID.AM-01
        uses: anchore/syft-action@v0.14.0
        with:
          output-file: sbom.spdx.json
          format: spdx-json
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json

  build:
    runs-on: ubuntu-latest
    needs: [unit-test, sast, secret-detection, sca, sbom]
    steps:
      - uses: actions/checkout@v4
      - name: Build Application Artifacts # Final compliance gate for deployable assets
        run: |
          echo "Building application artifacts..."
          # Placeholder: Add actual build commands here, e.g., npm run build, mvn package